<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Seguridad Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; }
        .card-enter { animation: slideIn 0.4s ease-out forwards; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="p-6 text-gray-800">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- Header -->
        <div class="lg:col-span-12 bg-white p-4 rounded-lg shadow-sm flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="monitor" class="text-blue-600"></i> Dashboard de Video Analytics
                </h1>
                <p class="text-xs text-gray-500 mt-1">Mostrando eventos recibidos en formato JSON completo</p>
            </div>
            <div id="status-badge" class="px-4 py-2 rounded-full bg-red-100 text-red-700 font-bold text-sm flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></span> Desconectado
            </div>
        </div>

        <!-- Panel Izquierdo: Simulador -->
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-lg font-bold mb-4 border-b pb-2 flex items-center gap-2">
                    <i data-lucide="send" class="w-5 h-5"></i> Simular Envío (Python)
                </h2>
                <p class="text-xs text-gray-500 mb-4">Envía este JSON exacto al endpoint <code>POST /api/internal/alerts</code>:</p>
                
                <form id="sim-form" class="space-y-3">
                    <div>
                        <label class="text-xs font-bold text-gray-600">camera_id</label>
                        <input type="number" id="camera_id" value="123" class="w-full border rounded p-2 text-sm font-mono">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-600">event_type</label>
                        <select id="event_type" class="w-full border rounded p-2 text-sm font-mono">
                            <option value="HIGH_RISK_AGGRESSION">HIGH_RISK_AGGRESSION</option>
                            <option value="MERODEO">MERODEO</option>
                            <option value="INTRUSION">INTRUSION</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-600">details</label>
                        <input type="text" id="details" value="Detección de movimientos violentos." class="w-full border rounded p-2 text-sm">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-600">clip_path</label>
                        <input type="text" id="clip_path" value="/media/clips/clip-20251102-173001.mp4" class="w-full border rounded p-2 text-sm font-mono">
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-bold text-sm transition shadow-lg mt-4 flex justify-center items-center gap-2">
                        <i data-lucide="zap" class="w-4 h-4"></i> Enviar JSON
                    </button>
                </form>
            </div>
        </div>

        <!-- Panel Derecho: Feed de Eventos -->
        <div class="lg:col-span-8">
            <div class="flex justify-between items-end mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="list" class="w-5 h-5"></i> Eventos Recientes
                </h2>
                <button onclick="document.getElementById('feed').innerHTML=''" class="text-xs text-red-500 hover:text-red-700 font-bold">Limpiar Lista</button>
            </div>
            
            <div id="feed" class="space-y-4 h-[calc(100vh-200px)] overflow-y-auto pr-2">
                <div class="text-center py-12 text-gray-400 bg-white rounded-lg border border-dashed border-gray-300">
                    Esperando eventos en tiempo real...
                </div>
            </div>
        </div>

    </div>

    <script>
        const BASE_URL = 'http://localhost:8080'; 
        let stompClient = null;

        // 1. Conexión WebSocket
        function connect() {
            const socket = new SockJS(BASE_URL + '/ws-bridge');
            stompClient = Stomp.over(socket);
            stompClient.debug = null;

            stompClient.connect({}, () => {
                const badge = document.getElementById('status-badge');
                badge.className = 'px-4 py-2 rounded-full bg-green-100 text-green-700 font-bold text-sm flex items-center gap-2 transition-all';
                badge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-600"></span> Conectado WS';

                stompClient.subscribe('/topic/alerts', (msg) => {
                    const data = JSON.parse(msg.body);
                    console.log("Datos recibidos WS:", data); // Para depuración
                    renderCard(data);
                });
                
                // Cargar historial inicial
                fetch(BASE_URL + '/api/alerts')
                    .then(res => res.json())
                    .then(data => {
                        if(data.length > 0) {
                            document.getElementById('feed').innerHTML = '';
                            data.forEach(renderCard);
                        }
                    });
            });
        }

        // 2. Renderizar Tarjeta
        function renderCard(event) {
            const feed = document.getElementById('feed');
            if(feed.innerText.includes('Esperando')) feed.innerHTML = '';

            // ---- CORRECCIÓN AQUÍ ----
            // Como Java usa @JsonProperty, el JSON de salida también usa snake_case.
            // Leemos ambas opciones por seguridad.
            const eventType = event.event_type || event.eventType || 'UNKNOWN';
            const cameraId = event.camera_id || event.cameraId || '??';
            const clipPath = event.clip_path || event.clipPath || 'No path';
            const timestamp = event.timestamp || new Date().toISOString();
            const details = event.details || 'Sin detalles';
            const id = event.id || '-';

            // Estilos
            let colorClass = 'border-l-4 border-blue-500';
            let bgClass = 'bg-white';
            
            if (eventType === 'HIGH_RISK_AGGRESSION') {
                colorClass = 'border-l-4 border-red-600';
                bgClass = 'bg-red-50';
            } else if (eventType === 'MERODEO') {
                colorClass = 'border-l-4 border-yellow-500';
            }

            const html = `
                <div class="card-enter p-5 rounded-lg shadow-sm border border-gray-200 ${bgClass} ${colorClass} relative overflow-hidden group hover:shadow-md transition-shadow">
                    
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="bg-gray-800 text-white text-xs px-2 py-1 rounded uppercase font-bold tracking-wider">
                                ${eventType}
                            </span>
                            <span class="ml-2 text-xs font-mono text-gray-500 bg-gray-100 px-2 py-1 rounded border">
                                ID DB: ${id}
                            </span>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-bold text-gray-600 flex items-center justify-end gap-1">
                                <i data-lucide="camera" class="w-3 h-3"></i> CAM ${cameraId}
                            </div>
                            <div class="text-[10px] text-gray-400 font-mono mt-1">
                                ${timestamp}
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-2">
                        <div class="flex items-start gap-2">
                            <i data-lucide="info" class="w-4 h-4 text-gray-400 mt-0.5 shrink-0"></i>
                            <p class="text-sm text-gray-700 font-medium leading-snug">
                                ${details}
                            </p>
                        </div>

                        <div class="flex items-center gap-2 bg-gray-100 p-2 rounded border border-gray-200 mt-2">
                            <i data-lucide="film" class="w-4 h-4 text-gray-500 shrink-0"></i>
                            <code class="text-xs text-blue-600 font-mono break-all select-all cursor-pointer hover:text-blue-800">
                                ${clipPath}
                            </code>
                        </div>
                    </div>
                </div>
            `;

            feed.insertAdjacentHTML('afterbegin', html);
            lucide.createIcons();
        }

        // 3. Enviar Simulación
        document.getElementById('sim-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const payload = {
                "camera_id": parseInt(document.getElementById('camera_id').value),
                "timestamp": new Date().toISOString(),
                "event_type": document.getElementById('event_type').value,
                "details": document.getElementById('details').value,
                "clip_path": document.getElementById('clip_path').value
            };

            fetch(BASE_URL + '/api/internal/alerts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            }).then(res => {
                if(res.ok) console.log("Enviado OK");
                else alert("Error en envío");
            }).catch(err => alert("Error de conexión"));
        });

        lucide.createIcons();
        connect();
    </script>
</body>
</html>